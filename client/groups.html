<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="http://meyerweb.com/eric/tools/css/reset/reset.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/grids-responsive-min.css">
    <link rel="stylesheet" type="text/css" media="screen" href="style.css">
</head>

<body>
<div class="pure-g">
    <div id="grapharea" class="pure-u-3-4">
        <div id="graph"></div>
    </div>
    <div class="pure-u-1-4">
        <div class="sidebar">
            <h1 id="pageTitle"></h1>

            <p>Click on a node to view group details.</p>

            <div id="nodeDetails">

            </div>

            <hr>
            <a href="index.html">About</a><br><br>
            <a href="cluster.html">Back to Word Clusters</a><br><br>

            <p>We had to choose different data to show which has set us back. Features still to come...</p>
            <ul>
                <li>Node changes color when selected, neighbor nodes change color</li>
                <li>Option to view details for single node only</li>
                <li>View users of a node and the groups they're in</li>
                <li>Filter based on minimum number of shared users, group privacy, number of users in group</li>
            </ul>
        </div>
    </div>

</div>

<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
    var w = document.getElementById('grapharea').offsetWidth - 30;
    var h = isNaN(window.innerHeight) ? window.clientHeight : window.innerHeight;

    // http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript
    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null
    }

    function nodeSelected(node) {

        if(node.length > 0){
            document.getElementById("nodeDetails").innerHTML = "";
        }else {
            document.getElementById("nodeDetails").innerHTML = "<table>" +
                    "<tr><td>Group</td><td><a target='_blank' href='http://flickr.com/groups/" + node.groupId + "'>" + node.name + "</a></td></tr>" +
                    "<tr><td>Tracked Member Count</td><td>" + node.trackedUserCount + "</td></tr>" +
                    "<tr><td>Total Member Count</td><td>" + node.userCount + "</td></tr>" +
                    "<tr><td>Photo Count</td><td>" + node.photoCount + "</td></tr>" +
                    "</table>";
        }
    }

    var force = d3.layout.force()
            .charge(-300)
        //     .chargeDistance(60)
            .linkDistance(350)
        //  .friction(.01)
            .theta(.2)
        //   .gravity(.5)
            .size([w, h]);
    var svg = d3.select("#graph")
            .append("svg")
            .attr("width", w)
            .attr("height", h)
            .style("background", "aqua");

    var word = getURLParameter('word');

    d3.json("http://travisolbrich.com:8080/groups/word/" + word, function (error, nodes) {
        if (error) throw error;

        d3.json("http://travisolbrich.com:8080/relations/word/" + word, function (error, edgesPreprocess) {
            if (error) throw error;

            document.getElementById("pageTitle").innerHTML = "Groups With '" + getURLParameter("word").charAt(0).toUpperCase() + (getURLParameter("word")).slice(1) + "'";

            // http://stackoverflow.com/questions/23986466/d3-force-layout-linking-nodes-by-name-instead-of-index
            var edges = [];
            edgesPreprocess.forEach(function (e) {
                var sourceNode = nodes.filter(function (n) {
                    return n.groupId === e.groupAId;
                })[0];
                var targetNode = nodes.filter(function (n) {
                    return n.groupId === e.groupBId;
                })[0];

                edges.push({
                    source: sourceNode,
                    target: targetNode,
                    value: e.memberCount
                });
            });

            force.nodes(nodes).links(edges).start();

            var link = svg.selectAll(".link")
                    .data(edges)
                    .enter().append("line")
                    .attr("class", "link")
                    .style("stroke", "#444")
                    .style("stroke-opacity", ".4")
                    .style("stroke-width", function (d) {
                        return Math.sqrt(d.value) / 2;
                    });

            var node = svg.selectAll(".node")
                    .data(nodes)
                    .enter().append("circle")
                    .attr("class", "node")
                    .attr("cx", function () {
                        return Math.random() * 450;
                    })
                    .attr("cy", function () {
                        return Math.random() * 450;
                    })
                    .attr("r", function (d) {
                        return Math.sqrt(d.trackedUserCount) / 1.2 + 5
                    })
                    .style("fill", "steelblue")          //function(d) { return color(1); }
                    .style("stroke", "darkgrey")
                    .style("stroke-width", "2px")
                    .style("fontcolor", "white")
                    //.on("click", fade(.1))
                    .on("click", fade(.1))
                    .call(force.drag);

            svg.on("click", function () {
                if(d3.event.target.localName == 'svg') {
                    svg.selectAll(".node").call(fade(.4));
                }
            });

            node.append("title").text(function (d) {
                return d.name;
            });

            //fade http://jsfiddle.net/tristanreid/xReHA/636/
            var linkedByIndex = {};
            edges.forEach(function (d) {
                linkedByIndex[d.source.index + "," + d.target.index] = 1;
            });

            function isConnected(a, b) {
                return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
            }

            function fade(opacity) {

                return function (d) {
                    nodeSelected(d);
                    node.style("stroke-opacity", function (o) {
                        thisOpacity = isConnected(d, o) ? 1 : opacity;
                        if(opacity == .4) {
                            thisOpacity = 1;
                        }
                        this.setAttribute('fill-opacity', thisOpacity);
                        return thisOpacity;
                    });

                    link.style("stroke-opacity", function (o) {
                        return o.source === d || o.target === d ? 1 : opacity;
                    });
                };
            }

            force.on("tick", function () {
                node.attr("cx", function (d) {
                    return d.x;
                })
                        .attr("cy", function (d) {
                            return d.y;
                        });
                link.attr("x1", function (d) {
                    return d.source.x;
                })
                        .attr("y1", function (d) {
                            return d.source.y;
                        })
                        .attr("x2", function (d) {
                            return d.target.x;
                        })
                        .attr("y2", function (d) {
                            return d.target.y;
                        });
            });

        })
    });
</script>
<!--<script src="cluster.js"></script>    -->
</body>
</html>
